<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coinflip - PVP Solana Wagers</title>
    <link rel="stylesheet" href="css/style.css?v=6">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1><span class="swords-icon"></span> Coinflip</h1>
                <p class="tagline">PVP Solana Wagers • Provably Fair</p>
            </div>
            <div id="authButtons" class="auth-buttons">
                <button class="btn btn-secondary" onclick="showAuthModal('login')">Login</button>
                <button class="btn btn-primary" onclick="showAuthModal('register')">Register</button>
            </div>
            <div id="userMenu" class="user-menu" style="display: none;">
                <button class="btn btn-user" onclick="showProfileModal()">
                    <span id="headerUsername">Profile</span>
                    <span id="headerTier" class="tier-badge">Starter</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Active Wagers Section -->
            <section class="wagers-section">
                <h2>Active Wagers</h2>
                <p class="section-subtitle">Accept a wager or create your own</p>

                <div id="activeWagers" class="wagers-list">
                    <div class="loading-wagers">Loading wagers...</div>
                </div>

                <button id="createWagerBtn" class="btn btn-primary btn-large">
                    Create New Wager
                </button>
            </section>

            <!-- Create Wager Modal -->
            <div id="createWagerModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeCreateModal()">&times;</span>

                    <!-- Step 1: Choose Side & Amount -->
                    <div id="step1" class="create-step">
                        <h2>Create PVP Wager</h2>

                        <div class="step-section">
                            <h3>1. Choose Your Side</h3>
                            <div class="side-selection">
                                <button class="side-btn" data-side="heads" onclick="selectSide('heads')">
                                    <span>HEADS</span>
                                </button>
                                <button class="side-btn" data-side="tails" onclick="selectSide('tails')">
                                    <span>TAILS</span>
                                </button>
                            </div>
                        </div>

                        <div class="step-section">
                            <h3>2. Wager Amount (SOL)</h3>
                            <div class="amount-buttons">
                                <button class="amount-btn" onclick="selectAmount(0.1)">0.1</button>
                                <button class="amount-btn" onclick="selectAmount(0.5)">0.5</button>
                                <button class="amount-btn" onclick="selectAmount(1)">1</button>
                                <button class="amount-btn" onclick="selectAmount(5)">5</button>
                            </div>
                            <div class="custom-amount">
                                <input type="number" id="customAmount" placeholder="Custom amount" step="0.01" min="0.01">
                                <button class="btn btn-secondary" onclick="useCustomAmount()">Use</button>
                            </div>
                        </div>

                        <div class="step-section">
                            <h3>3. Your Solana Address (to receive winnings)</h3>
                            <input type="text" id="creatorWallet" class="wallet-input" placeholder="Your Solana wallet address">
                        </div>

                        <div id="wagerSummary" class="wager-summary" style="display: none;">
                            <h3>Summary</h3>
                            <div class="summary-row">
                                <span>Side:</span>
                                <span id="summarySide">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Wager:</span>
                                <span id="summaryAmount">-</span>
                            </div>
                            <div class="summary-row highlight">
                                <span>Total to Deposit:</span>
                                <span id="summaryTotal">-</span>
                            </div>
                            <p class="fee-note">Includes 0.025 SOL network fee</p>
                        </div>

                        <button id="continueBtn" class="btn btn-primary btn-large" onclick="continueToDeposit()" disabled>
                            Continue →
                        </button>
                    </div>

                    <!-- Step 2: Deposit Instructions -->
                    <div id="step2" class="create-step" style="display: none;">
                        <h2>Deposit to Escrow</h2>

                        <div class="escrow-info">
                            <p>Send exactly <strong id="depositAmount">-</strong> SOL to this escrow wallet:</p>

                            <div class="escrow-address-box">
                                <code id="escrowAddress">-</code>
                                <button class="copy-btn" onclick="copyEscrowAddress()">Copy</button>
                            </div>

                            <div class="qr-placeholder">
                                <p>Scan with any Solana wallet</p>
                            </div>
                        </div>

                        <div class="deposit-steps">
                            <p>1. Open your Solana wallet (Phantom, Solflare, etc.)</p>
                            <p>2. Send exactly <strong id="depositAmount2">-</strong> SOL</p>
                            <p>3. Paste transaction signature below</p>
                        </div>

                        <div class="tx-input-section">
                            <label>Transaction Signature:</label>
                            <input type="text" id="depositTxSignature" class="tx-input" placeholder="Paste your transaction signature here">
                        </div>

                        <button id="verifyDepositBtn" class="btn btn-primary btn-large" onclick="verifyDeposit()">
                            Verify Deposit & Create Wager
                        </button>

                        <button class="btn btn-secondary" onclick="backToStep1()">← Back</button>
                    </div>

                    <!-- Step 3: Success -->
                    <div id="step3" class="create-step" style="display: none;">
                        <div class="success-content">
                            <div class="success-icon">Success</div>
                            <h2>Wager Created!</h2>
                            <p>Your wager is now live and waiting for an opponent.</p>

                            <div class="wager-details">
                                <div class="detail-row">
                                    <span>Wager ID:</span>
                                    <span id="newWagerId">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>Amount:</span>
                                    <span id="newWagerAmount">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>Your Side:</span>
                                    <span id="newWagerSide">-</span>
                                </div>
                            </div>

                            <p class="waiting-text">Waiting for opponent to accept...</p>

                            <button class="btn btn-primary" onclick="closeCreateModal()">Done</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accept Wager Modal -->
            <div id="acceptWagerModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeAcceptModal()">&times;</span>

                    <!-- Step 1: Confirm & Enter Wallet -->
                    <div id="acceptStep1" class="create-step">
                        <h2>Accept Wager</h2>

                        <div class="wager-to-accept">
                            <div class="accept-row">
                                <span>Wager Amount:</span>
                                <span id="acceptAmount" class="highlight">-</span>
                            </div>
                            <div class="accept-row">
                                <span>Creator's Side:</span>
                                <span id="acceptCreatorSide">-</span>
                            </div>
                            <div class="accept-row">
                                <span>Your Side:</span>
                                <span id="acceptYourSide" class="highlight">-</span>
                            </div>
                            <div class="accept-row total">
                                <span>Total to Deposit:</span>
                                <span id="acceptTotal">-</span>
                            </div>
                        </div>

                        <div class="step-section">
                            <h3>Your Solana Address (to receive winnings)</h3>
                            <input type="text" id="acceptorWallet" class="wallet-input" placeholder="Your Solana wallet address">
                        </div>

                        <button id="acceptContinueBtn" class="btn btn-primary btn-large" onclick="continueToAcceptDeposit()">
                            Continue to Deposit →
                        </button>

                        <button class="btn btn-secondary" onclick="closeAcceptModal()">Cancel</button>
                    </div>

                    <!-- Step 2: Deposit -->
                    <div id="acceptStep2" class="create-step" style="display: none;">
                        <h2>Deposit to Accept</h2>

                        <div class="escrow-info">
                            <p>Send exactly <strong id="acceptDepositAmount">-</strong> SOL to this escrow wallet:</p>

                            <div class="escrow-address-box">
                                <code id="acceptEscrowAddress">-</code>
                                <button class="copy-btn" onclick="copyAcceptEscrowAddress()">Copy</button>
                            </div>
                        </div>

                        <div class="tx-input-section">
                            <label>Transaction Signature:</label>
                            <input type="text" id="acceptTxSignature" class="tx-input" placeholder="Paste your transaction signature here">
                        </div>

                        <button id="verifyAcceptBtn" class="btn btn-primary btn-large" onclick="verifyAcceptDeposit()">
                            Verify & Execute Coinflip
                        </button>

                        <button class="btn btn-secondary" onclick="backToAcceptStep1()">← Back</button>
                    </div>

                    <!-- Step 3: Result -->
                    <div id="acceptStep3" class="create-step" style="display: none;">
                        <div id="gameResultContent">
                            <!-- Filled by JavaScript -->
                        </div>
                        <button class="btn btn-primary" onclick="closeAcceptModal()">Done</button>
                    </div>
                </div>
            </div>

            <!-- Recent Games Section -->
            <section class="recent-games-section">
                <h2>Recent Games</h2>
                <p class="section-subtitle">Click any game to verify - blockhash shown below each result</p>
                <div id="recentGames" class="recent-games-list">
                    <div class="loading-games">Loading recent games...</div>
                </div>
            </section>

            <!-- How It Works -->
            <section class="how-it-works">
                <h2>How It Works</h2>
                <div class="steps-grid">
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <h3>Create or Accept</h3>
                        <p>Create a wager with your chosen side and amount, or accept an existing wager</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">2</div>
                        <h3>Deposit to Escrow</h3>
                        <p>Send your wager + 0.025 SOL fee to a unique escrow wallet</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">3</div>
                        <h3>Coinflip!</h3>
                        <p>When both deposits are verified, the coin flips using Solana blockhash</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">4</div>
                        <h3>Winner Gets Paid</h3>
                        <p>Winner receives 98% of both wagers instantly (2% platform fee)</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Auth Modal -->
        <div id="authModal" class="modal" style="display: none;">
            <div class="modal-content auth-modal-content">
                <span class="modal-close" onclick="closeAuthModal()">&times;</span>

                <!-- Login Form -->
                <div id="loginForm" class="auth-form">
                    <h2>Login</h2>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="Your username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Your password">
                    </div>
                    <button class="btn btn-primary btn-large" onclick="handleLogin()">Login</button>
                    <p class="auth-switch">
                        Don't have an account? <a href="#" onclick="switchAuthForm('register')">Register</a>
                    </p>
                    <p class="auth-recovery">
                        Forgot password? <a href="#" onclick="showSupportModal('password_reset')">Request Reset</a>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <h2>Create Account</h2>
                    <div class="form-group">
                        <label>Email <span class="info-tooltip" title="An email is required only to send the user a new password when needed, and will never be shared with third parties">?</span></label>
                        <input type="email" id="registerEmail" class="form-input" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="registerUsername" class="form-input" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="Min 8 chars, include number">
                    </div>
                    <div class="form-group">
                        <label>Referral Code (optional)</label>
                        <input type="text" id="registerReferral" class="form-input" placeholder="Enter referral code">
                    </div>
                    <button class="btn btn-primary btn-large" onclick="handleRegister()">Create Account</button>
                    <p class="auth-switch">
                        Already have an account? <a href="#" onclick="switchAuthForm('login')">Login</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="modal" style="display: none;">
            <div class="modal-content profile-modal-content">
                <span class="modal-close" onclick="closeProfileModal()">&times;</span>
                <h2>Your Profile</h2>

                <!-- Profile Stats -->
                <div class="profile-section">
                    <h3>Stats</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="profileGamesPlayed">0</span>
                            <span class="stat-label">Games</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="profileWinRate">0%</span>
                            <span class="stat-label">Win Rate</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="profileVolume">0</span>
                            <span class="stat-label">Volume (SOL)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="profileProfit">0</span>
                            <span class="stat-label">Profit (SOL)</span>
                        </div>
                    </div>
                </div>

                <!-- Tier Progress -->
                <div class="profile-section">
                    <h3>Tier: <span id="profileTier" class="tier-value">Starter</span></h3>
                    <div class="tier-progress-bar">
                        <div id="tierProgressFill" class="tier-progress-fill" style="width: 0%"></div>
                    </div>
                    <p class="tier-progress-text" id="tierProgressText">0 SOL to Bronze</p>
                </div>

                <!-- Payout Wallet -->
                <div class="profile-section">
                    <h3>Payout Wallet</h3>
                    <input type="text" id="profilePayoutWallet" class="form-input" placeholder="Your Solana wallet for winnings">
                    <button class="btn btn-secondary" onclick="updatePayoutWallet()">Save Wallet</button>
                </div>

                <!-- Referrals -->
                <div class="profile-section">
                    <h3>Referrals</h3>
                    <div class="referral-box">
                        <div class="referral-code-edit">
                            <label>Your Referral Code (3-16 chars)</label>
                            <div class="referral-code-input-row">
                                <input type="text" id="customReferralCode" class="form-input" maxlength="16" placeholder="Enter custom code">
                                <button class="btn btn-secondary" onclick="updateReferralCode()">Save</button>
                                <button class="copy-btn" onclick="copyReferralCode()">Copy</button>
                            </div>
                            <p class="referral-link-display">Link: <a id="profileReferralLink" href="#" target="_blank">-</a></p>
                        </div>
                        <div class="referral-stats">
                            <div class="referral-stat">
                                <span class="stat-value" id="profileReferrals">0</span>
                                <span class="stat-label">Referrals</span>
                            </div>
                            <div class="referral-stat">
                                <span class="stat-value" id="profilePendingEarnings">0</span>
                                <span class="stat-label">Pending (SOL)</span>
                            </div>
                            <div class="referral-stat">
                                <span class="stat-value" id="profileClaimedEarnings">0</span>
                                <span class="stat-label">Claimed (SOL)</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="claimReferralEarnings()" id="claimReferralBtn">
                            Claim Earnings
                        </button>
                        <div class="referral-rates-info">
                            <p class="referral-rate-current">Your Rate: <span id="profileReferralRate">0%</span></p>
                            <div class="tier-rates-table">
                                <span>Starter: 0%</span>
                                <span>Bronze: 2.5%</span>
                                <span>Silver: 5%</span>
                                <span>Gold: 7.5%</span>
                                <span>Diamond: 10%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- Support/Password Reset Modal -->
        <div id="supportModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="modal-close" onclick="closeSupportModal()">&times;</span>
                <h2 id="supportModalTitle">Contact Support</h2>

                <form id="supportForm" onsubmit="submitSupportTicket(event)">
                    <div class="form-group">
                        <label>Your Email</label>
                        <input type="email" id="supportEmail" class="form-input" placeholder="your@email.com" required>
                    </div>

                    <div class="form-group">
                        <label>Type</label>
                        <select id="supportType" class="form-input">
                            <option value="support">General Support</option>
                            <option value="password_reset">Password Reset</option>
                            <option value="bug_report">Bug Report</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="supportSubject" class="form-input" placeholder="Brief description" required>
                    </div>

                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="supportMessage" class="form-input" rows="4" placeholder="Describe your issue in detail..." required></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-large" id="supportSubmitBtn">
                        Submit Ticket
                    </button>

                    <p id="supportStatus" class="auth-error" style="display: none;"></p>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Provably Fair - All results verifiable on Solana blockchain</p>
            <p class="footer-links">
                <a href="#" onclick="showFairnessInfo()">How Fairness Works</a> |
                <a href="#" onclick="showSupportModal()">Contact Support</a>
            </p>
        </footer>
    </div>

    <script src="js/app.js?v=6"></script>
</body>
</html>
